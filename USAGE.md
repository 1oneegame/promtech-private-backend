# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é IntegrityOS ML API

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```powershell
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
& .\venv\Scripts\Activate.ps1

# –ó–∞–ø—É—Å—Ç–∏—Ç—å API —Å–µ—Ä–≤–µ—Ä
python main.py
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ `http://localhost:8000`

---

## –û—Å–Ω–æ–≤–Ω—ã–µ endpoint'—ã

### üìä –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –¥–µ—Ñ–µ–∫—Ç–∞

**POST** `/ml/predict`

–ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –¥–µ—Ñ–µ–∫—Ç–∞ (normal/medium/high) —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl -X POST "http://localhost:8000/ml/predict" \
  -H "Content-Type: application/json" \
  -d '{
    "pipeline_id": "AKT-KZ",
    "measurement_distance_m": 168543.1,
    "defect_type": "–∫–æ—Ä—Ä–æ–∑–∏—è",
    "depth_percent": 14.5,
    "latitude": 45.818282,
    "longitude": 51.739739,
    "altitude_m": 34.4,
    "surface_location": "–í–ù–®",
    "erf_b31g": 0.95
  }'
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "severity": "medium",
  "probability": 1.0,
  "probabilities": {
    "normal": 0.0,
    "medium": 1.0,
    "high": 0.0
  },
  "model_type": "RandomForest",
  "prediction_timestamp": "2025-12-06T20:28:38.733375"
}
```

---

### ‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏

**GET** `/ml/model/info`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π ML –º–æ–¥–µ–ª–∏.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl http://localhost:8000/ml/model/info
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "status": "loaded",
  "model_type": "RandomForest",
  "f1_score": 0.9781,
  "training_date": "2025-12-06T20:28:38.733375",
  "calibration_method": "isotonic",
  "feature_count": 20
}
```

---

### üìà –ú–µ—Ç—Ä–∏–∫–∏ –º–æ–¥–µ–ª–µ–π

**GET** `/ml/model/metrics`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤—Å–µ—Ö –æ–±—É—á–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (—Ç–æ—á–Ω–æ—Å—Ç—å, F1-score, confusion matrix).

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```bash
curl http://localhost:8000/ml/model/metrics
```

---

### üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤

**GET** `/defects`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `pipeline_id` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "AKT-KZ")
- `defect_type` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –¥–µ—Ñ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∫–æ—Ä—Ä–æ–∑–∏—è")
- `severity` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ (normal/medium/high)
- `limit` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
- `skip` - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å–∏ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl "http://localhost:8000/defects?pipeline_id=AKT-KZ&severity=medium&limit=10"
```

---

### üéØ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –ø–æ ID

**GET** `/defects/{defect_id}`

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –¥–µ—Ñ–µ–∫—Ç–µ.

**–ü—Ä–∏–º–µ—Ä:**

```bash
curl http://localhost:8000/defects/674d0fc7e7e43d9ba9cce9f8
```

---

## –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

–ï—Å–ª–∏ —É –≤–∞—Å –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏:

```powershell
# 1. –ü–æ–ª–æ–∂–∏—Ç–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ output/kazakhstan_defects_real_coordinates.csv

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ
python train_model.py

# 3. –ú–æ–¥–µ–ª—å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ models/best_model.joblib

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
python main.py
```

---

## –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

–¢–∞–º –≤—ã –º–æ–∂–µ—Ç–µ:
- –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ endpoint'—ã
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Python

```python
import requests

# –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
response = requests.post(
    "http://localhost:8000/ml/predict",
    json={
        "pipeline_id": "CPC-KZ",
        "measurement_distance_m": 200000,
        "defect_type": "—Ç—Ä–µ—â–∏–Ω–∞",
        "depth_percent": 18.5,
        "latitude": 46.0,
        "longitude": 52.0,
        "altitude_m": 40.0,
        "surface_location": "–í–ù–¢",
        "erf_b31g": 0.82
    }
)

result = response.json()
print(f"–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å: {result['severity']}")
print(f"–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: {result['probability']:.1%}")
```

### JavaScript

```javascript
// –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
fetch('http://localhost:8000/ml/predict', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    pipeline_id: 'AKT-KZ',
    measurement_distance_m: 150000,
    defect_type: '–∫–æ—Ä—Ä–æ–∑–∏—è',
    depth_percent: 12.0,
    latitude: 45.5,
    longitude: 51.5,
    altitude_m: 35.0,
    surface_location: '–í–ù–®',
    erf_b31g: 0.88
  })
})
.then(res => res.json())
.then(data => {
  console.log('–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:', data.severity);
  console.log('–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏:', data.probabilities);
});
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã:

```powershell
# –¢–µ—Å—Ç ML API endpoints
python test_ml_api.py

# –¢–µ—Å—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
python test_predictions.py
```

---

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–µ–π

–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ —Å:
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: RandomForest (–ª—É—á—à–∞—è), XGBoost, LogisticRegression
- **–¢–æ—á–Ω–æ—Å—Ç—å**: ~97%
- **F1 Score**: 96-98%
- **–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞**: Isotonic
- **Data Augmentation**: 25% Gaussian noise + 15% feature dropout

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `src/ml/config.py`

---

## –¢—Ä–µ–±—É–µ–º—ã–µ –ø–æ–ª—è –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------|-----|----------|--------|
| `pipeline_id` | string | ID —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥–∞ | "AKT-KZ" |
| `measurement_distance_m` | float | –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤–¥–æ–ª—å —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥–∞ (–º) | 168543.1 |
| `defect_type` | string | –¢–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞ | "–∫–æ—Ä—Ä–æ–∑–∏—è" |
| `depth_percent` | float | –ì–ª—É–±–∏–Ω–∞ –¥–µ—Ñ–µ–∫—Ç–∞ (%) | 14.5 |
| `latitude` | float | –®–∏—Ä–æ—Ç–∞ (-90 –¥–æ 90) | 45.818282 |
| `longitude` | float | –î–æ–ª–≥–æ—Ç–∞ (-180 –¥–æ 180) | 51.739739 |
| `altitude_m` | float | –í—ã—Å–æ—Ç–∞ –Ω–∞–¥ —É—Ä–æ–≤–Ω–µ–º –º–æ—Ä—è (–º) | 34.4 |
| `surface_location` | string | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–í–ù–®/–í–ù–¢) | "–í–ù–®" |
| `erf_b31g` | float | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç ERF B31G (0-1) | 0.95 |

---

## –¢–∏–ø—ã –¥–µ—Ñ–µ–∫—Ç–æ–≤

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã:
- –∫–æ—Ä—Ä–æ–∑–∏—è
- –≤–Ω–µ—à–Ω—è—è –∫–æ—Ä—Ä–æ–∑–∏—è
- —Ç—Ä–µ—â–∏–Ω–∞
- —Ç—Ä–µ—â–∏–Ω–∞ –Ω–∞ —à–≤–µ
- –≤–º—è—Ç–∏–Ω–∞
- —Å–≤–∞—Ä–Ω–æ–π —à–æ–≤
- —Ä–∞—Å—Å–ª–æ–µ–Ω–∏–µ
- –∑–∞–¥–∏—Ä
- —Ü–∞—Ä–∞–ø–∏–Ω–∞
- –∏ –¥—Ä—É–≥–∏–µ...

---

## Troubleshooting

**–û—à–∏–±–∫–∞: ML –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞**
```
–†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—É—Å—Ç–∏—Ç–µ python train_model.py –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
```

**–û—à–∏–±–∫–∞: MongoDB connection failed**
```
–†–µ—à–µ–Ω–∏–µ: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ MongoDB –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ CONNECTION_STRING –≤ src/database.py
```

**–û—à–∏–±–∫–∞: Module not found**
```
–†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ - pip install -r requirements.txt
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
terricon/
‚îú‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ train_model.py         # –°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ test_ml_api.py         # –¢–µ—Å—Ç—ã API
‚îú‚îÄ‚îÄ requirements.txt       # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.py            # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ database.py       # MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # Pydantic –º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ ml/               # ML –º–æ–¥—É–ª—å
‚îÇ       ‚îú‚îÄ‚îÄ config.py     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ features.py   # Feature engineering
‚îÇ       ‚îú‚îÄ‚îÄ train.py      # –û–±—É—á–µ–Ω–∏–µ
‚îÇ       ‚îî‚îÄ‚îÄ inference.py  # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ models/               # –û–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ best_model.joblib
‚îÇ   ‚îú‚îÄ‚îÄ metrics.json
‚îÇ   ‚îî‚îÄ‚îÄ feature_importance.png
‚îî‚îÄ‚îÄ output/              # –î–∞–Ω–Ω—ã–µ
    ‚îî‚îÄ‚îÄ kazakhstan_defects_real_coordinates.csv
```

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
